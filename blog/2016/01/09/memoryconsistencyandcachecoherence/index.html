
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Memory Consistency和Cache Coherence - Yebangyu's Blog</title>
  <meta name="author" content="Yebangyu">

  
  <meta name="description" content="Cache Coherence Memory Consistency 缓存一致性 内存模型 Sequential Consistency">
  <meta name="keywords" content="Cache Coherence Memory Consistency 缓存一致性 内存模型 Sequential Consistency">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.yebangyu.org/blog/2016/01/09/memoryconsistencyandcachecoherence/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Yebangyu's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.useso.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Yebangyu's Blog</a></h1>
  
    <h2>Specialized in Concurrency Programming and C++.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.baidu.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.yebangyu.org">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Memory Consistency和Cache Coherence</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-09T22:52:52+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:52 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2 id="memory-consistency">Memory Consistency</h2>

<p>Memory Consistency(MC)，有时候又叫做Memory Consistency Model或者Memory Model。为了理解为什么需要引入这种东西，我们首先看以下程序：</p>

<!--more-->

<pre><code>初始：x=0 y=0

Thread1：

S1：x=1

L1：r1=y

Thread2：

S2：y=2

L2：r2=x
</code></pre>

<p>两个线程执行完之后，r1和r2可能是什么值？</p>

<p>注意到线程是并发、交替执行的，下面是可能的执行顺序和相应结果：</p>

<p>S1 L1 S2 L2 那么r1=0 r2=2
S1 S2 L1 L2 那么r1=1 r2=2
S2 L2 S1 L1 那么r1=2 r2=0</p>

<p>这些都是意料之内、情理之中的。但是在x86体系结构下，很可能得到r1=0 r2=0这样的结果。是不是大吃一惊？</p>

<p>如果没有Memory Consistency，那么程序员对于自己编写的多线程程序会输出什么将一无所知：天知道会输出什么。</p>

<p>因此，Memory Consistency就是一种程序员（编程语言）、编译器、CPU间的协议。这个协议保证了程序读取内存时可能得到什么值，会得到什么值。</p>

<h2 id="sequential-consistency">Sequential Consistency</h2>

<p>在Sequential Consistency这种Memory Model下，刚才讨论的那个程序不可能输出r1=0 r2=0这种结果。此话怎讲？这就牵涉到一个问题：什么是Sequential Consistency（SC）</p>

<p>根据Leslie Lamport在1979年9月发表的论文”How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Programs”里提出的SC的定义：</p>

<p>the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program.</p>

<p>根据这个定义，在SC模型下，任何execution的执行顺序（我们称为Total Order）必须respect每个线程的Program Order。什么是Program Order？对于以上程序，在Thread1中，S1先于L1；在Thread2中，S2先于L2。这就是Program Order。</p>

<p>请时刻注意，Program Order只针对某个线程内的语句而言，不涉及到跨线程。比如Thread1中的S1和Thread2中的L2，就无所谓什么Program Order了。</p>

<p>好了，现在知道为什么在SC下，有些结果可能出现，有些不可能了。</p>

<p>S1 L1 S2 L2 那么r1=0 r2=2 没问题，没有违背S1&lt;L1 S2&lt;L2
S1 S2 L1 L2 那么r1=1 r2=2 没问题，没有违背S1&lt;L1 S2&lt;L2
S2 L2 S1 L1 那么r1=2 r2=0 没问题，没有违背S1&lt;L1 S2&lt;L2</p>

<p>而对于r1=0 r2=0，在SC下，我们找不到一个能respect Program Order的Memory Order。因为r1=0，说明L1&lt;S2，r2=0说明L2&lt;S1；而S1&lt;L1，S2&lt;L2，不难看出这里形成了一个环。</p>

<h2 id="cache-coherence">Cache Coherence</h2>

<p>还是先搬出这张图吧:</p>

<p><img src="http://7xnljs.com1.z0.glb.clouddn.com/cpuand%20cache.png" alt="memorycache" /></p>

<p>(图片来源于Paul大叔的《Is Parallel Programming Hard》这本书第三章)</p>

<p>多个CPU cores，每个core上有自己的Cache。我们知道，Cache是部分内存的映射和缓存，或者说，副本。这就带来一个问题：副本一致性。内存只有一个，每个cpu cores却有自己的内存副本，如何保证大家看到的内容是一样的、一致的、正确的呢？这就是Cache Coherence(CC)要解决的问题。</p>

<h2 id="cache-coherence--vs-memory-consistency">Cache Coherence  VS Memory Consistency</h2>

<p>从以上分析，我们不难看出。CC和MC涉及的是两个不同层面的东西，解决的是不同的问题，不可混淆。CC解决的是副本一致性问题；MC保证的是多线程程序可以读到什么值。</p>

<p>两者有联系吗？有。实现Memory Consistency时，Cache Coherence有时候可以作为一个black box tool来使用。细节下次我们接着聊。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yebangyu</span></span>

      




<time class='entry-date' datetime='2016-01-09T22:52:52+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>10:52 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/bing-xing-bian-cheng/'>并行编程</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/01/07/timingcprograminlinux/" title="Previous Post: Linux下C++程序计时方法">&laquo; Linux下C++程序计时方法</a>
      
      
    </p>
  </footer>
</article>


</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/09/memoryconsistencyandcachecoherence/">Memory Consistency和Cache Coherence</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/07/timingcprograminlinux/">Linux下C++程序计时方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/falsesharing/">诡异的程序性能问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/26/aprogrammersclock/">程序员时钟解读</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/19/cuckoo-hashing/">Introduction To Cuckoo Hashing</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>友情链接</h1>
  <ul>
    <li>
	  <li><a href="http://www.chongh.wiki/">wangchonghua</a></li>
      <li><a href="http://www.armsword.com">armsword</a></li>
    </li>
  </ul>
</section><section>
  <h1>Yebangyu</h1>
  <p>福建人。热爱历史、K歌、NBA</p>
  <p>帝都码农</p>
  <p>历史学家，专治三国史</p>
</section>
<section>
 <h1>Categories</h1>
 <ul id="categories">
  <li class='category'><a href='/blog/categories/c-plus-plus/'>c++ (5)</a></li>
<li class='category'><a href='/blog/categories/web/'>web (1)</a></li>
<li class='category'><a href='/blog/categories/qi-ta/'>其他 (4)</a></li>
<li class='category'><a href='/blog/categories/li-shi/'>历史 (1)</a></li>
<li class='category'><a href='/blog/categories/bing-xing-bian-cheng/'>并行编程 (7)</a></li>
<li class='category'><a href='/blog/categories/suan-fa/'>算法 (1)</a></li>
<li class='category'><a href='/blog/categories/bian-yi-lian-jie/'>编译链接 (2)</a></li>

 </ul>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<p>
  Copyright &copy; 2016 - Yebangyu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
